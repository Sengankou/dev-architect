<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dev Architect - Ë¶Å‰ª∂ÂÆöÁæ©ÊîØÊè¥</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI",
                    "Hiragino Sans", "Yu Gothic UI", sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
            }

            .container {
                width: 100%;
                max-width: 800px;
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                display: flex;
                flex-direction: column;
                height: 90vh;
                max-height: 700px;
            }

            .header {
                padding: 24px;
                border-bottom: 1px solid #e5e7eb;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 16px 16px 0 0;
            }

            .header h1 {
                font-size: 24px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .header p {
                font-size: 14px;
                opacity: 0.9;
            }

            .messages {
                flex: 1;
                overflow-y: auto;
                padding: 24px;
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .message {
                display: flex;
                flex-direction: column;
                max-width: 80%;
                animation: fadeIn 0.3s ease-in-out;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .message.user {
                align-self: flex-end;
            }

            .message.assistant {
                align-self: flex-start;
            }

            .message-label {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 4px;
                font-weight: 500;
            }

            .message-content {
                padding: 12px 16px;
                border-radius: 12px;
                line-height: 1.6;
                word-wrap: break-word;
                white-space: pre-wrap;
            }

            .message.user .message-content {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .message.assistant .message-content {
                background: #f3f4f6;
                color: #1f2937;
                border: 1px solid #e5e7eb;
            }

            .input-area {
                padding: 24px;
                border-top: 1px solid #e5e7eb;
                background: #f9fafb;
                border-radius: 0 0 16px 16px;
            }

            .input-form {
                display: flex;
                gap: 12px;
            }

            textarea {
                flex: 1;
                padding: 12px 16px;
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                font-size: 14px;
                font-family: inherit;
                resize: none;
                min-height: 60px;
                max-height: 120px;
                transition: border-color 0.2s;
            }

            textarea:focus {
                outline: none;
                border-color: #667eea;
            }

            button {
                padding: 12px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition:
                    opacity 0.2s,
                    transform 0.1s;
                white-space: nowrap;
            }

            button:hover:not(:disabled) {
                opacity: 0.9;
                transform: translateY(-1px);
            }

            button:active:not(:disabled) {
                transform: translateY(0);
            }

            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .error-message {
                padding: 12px 16px;
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 12px;
                color: #dc2626;
                font-size: 14px;
                margin-bottom: 16px;
                animation: fadeIn 0.3s ease-in-out;
            }

            .loading {
                display: flex;
                gap: 8px;
                padding: 12px 16px;
                align-self: flex-start;
            }

            .loading-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #667eea;
                animation: bounce 1.4s infinite ease-in-out both;
            }

            .loading-dot:nth-child(1) {
                animation-delay: -0.32s;
            }

            .loading-dot:nth-child(2) {
                animation-delay: -0.16s;
            }

            @keyframes bounce {
                0%,
                80%,
                100% {
                    transform: scale(0);
                }
                40% {
                    transform: scale(1);
                }
            }

            .empty-state {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                color: #9ca3af;
                text-align: center;
                padding: 40px;
            }

            .empty-state h2 {
                font-size: 20px;
                margin-bottom: 8px;
                color: #6b7280;
            }

            .empty-state p {
                font-size: 14px;
            }

            /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥ */
            @media (max-width: 768px) {
                body {
                    padding: 0;
                }

                .container {
                    max-width: 100%;
                    height: 100vh;
                    max-height: 100vh;
                    border-radius: 0;
                }

                .header {
                    border-radius: 0;
                }

                .input-area {
                    border-radius: 0;
                }

                .header h1 {
                    font-size: 20px;
                }

                .message {
                    max-width: 90%;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Dev Architect</h1>
                <p>Ë¶Å‰ª∂ÂÆöÁæ©ÊîØÊè¥„Ç®„Éº„Ç∏„Çß„É≥„Éà</p>
            </div>

            <div class="messages" id="messages">
                <div class="empty-state">
                    <h2>üëã „Çà„ÅÜ„Åì„Åù</h2>
                    <p>Ë¶Å‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„ÄÅÂØæË©±ÁöÑ„Å´‰ªïÊßò„ÇíÁ≤æÁ∑ªÂåñ„Åó„Åæ„Åó„Çá„ÅÜ</p>
                </div>
            </div>

            <div class="input-area">
                <div id="error-container"></div>
                <form class="input-form" id="chat-form">
                    <textarea
                        id="message-input"
                        placeholder="Ë¶Å‰ª∂„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰æã: EC„Çµ„Ç§„Éà„ÅÆ„Ç´„Éº„ÉàÊ©üËÉΩ„ÇíÂÆüË£Ö„Åó„Åü„ÅÑ„Åß„ÅôÔºâ"
                        rows="3"
                    ></textarea>
                    <button type="submit" id="send-button">ÈÄÅ‰ø°</button>
                </form>
            </div>
        </div>

        <script>
            // „Ç∞„É≠„Éº„Éê„É´Áä∂ÊÖã
            let sessionId = localStorage.getItem("sessionId");
            let isLoading = false;

            // DOMË¶ÅÁ¥†
            const messagesContainer = document.getElementById("messages");
            const messageInput = document.getElementById("message-input");
            const sendButton = document.getElementById("send-button");
            const chatForm = document.getElementById("chat-form");
            const errorContainer = document.getElementById("error-container");

            // XSSÂØæÁ≠ñ: textContent„Çí‰ΩøÁî®„Åó„Å¶HTML„Ç®„Çπ„Ç±„Éº„Éó
            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.textContent;
            }

            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
            function showError(message) {
                errorContainer.innerHTML = "";
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.textContent = message;
                errorContainer.appendChild(errorDiv);

                // 5ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
                setTimeout(() => {
                    errorDiv.remove();
                }, 5000);
            }

            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇØ„É™„Ç¢
            function clearError() {
                errorContainer.innerHTML = "";
            }

            // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
            function addMessage(role, content) {
                // Á©∫„ÅÆÁä∂ÊÖã„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
                const emptyState =
                    messagesContainer.querySelector(".empty-state");
                if (emptyState) {
                    emptyState.remove();
                }

                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${role}`;

                const labelDiv = document.createElement("div");
                labelDiv.className = "message-label";
                labelDiv.textContent = role === "user" ? "„ÅÇ„Å™„Åü" : "AI";

                const contentDiv = document.createElement("div");
                contentDiv.className = "message-content";
                contentDiv.textContent = content; // XSSÂØæÁ≠ñ: textContent‰ΩøÁî®

                messageDiv.appendChild(labelDiv);
                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);

                // ÊúÄÊñ∞„É°„ÉÉ„Çª„Éº„Ç∏„Å´„Çπ„ÇØ„É≠„Éº„É´
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
            function showLoading() {
                const loadingDiv = document.createElement("div");
                loadingDiv.className = "loading";
                loadingDiv.id = "loading-indicator";
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement("div");
                    dot.className = "loading-dot";
                    loadingDiv.appendChild(dot);
                }
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÂâäÈô§
            function hideLoading() {
                const loadingIndicator =
                    document.getElementById("loading-indicator");
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
            }

            // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
            async function sendMessage(message) {
                if (isLoading) return;
                if (!message || message.trim().length === 0) {
                    showError("„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                    return;
                }

                clearError();
                isLoading = true;
                sendButton.disabled = true;
                sendButton.textContent = "ÈÄÅ‰ø°‰∏≠...";

                // „É¶„Éº„Ç∂„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂç≥Â∫ß„Å´Ë°®Á§∫
                addMessage("user", message);
                messageInput.value = "";

                // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
                showLoading();

                try {
                    const response = await fetch("/api/chat", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            sessionId: sessionId || undefined,
                            message: message,
                        }),
                    });

                    hideLoading();

                    if (!response.ok) {
                        const errorData = await response.json();
                        let errorMessage = "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü";

                        if (response.status === 400) {
                            errorMessage =
                                errorData.details || "„É°„ÉÉ„Çª„Éº„Ç∏„Åå‰∏çÊ≠£„Åß„Åô";
                        } else if (response.status === 503) {
                            errorMessage =
                                errorData.details ||
                                "AIÂøúÁ≠î„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                        }

                        showError(errorMessage);
                        return;
                    }

                    const data = await response.json();

                    // „Çª„ÉÉ„Ç∑„Éß„É≥ID‰øùÂ≠ò
                    if (data.sessionId) {
                        sessionId = data.sessionId;
                        localStorage.setItem("sessionId", sessionId);
                    }

                    // AIÂøúÁ≠î„ÇíË°®Á§∫
                    if (data.response) {
                        addMessage("assistant", data.response);
                    }
                } catch (error) {
                    hideLoading();
                    console.error("Error sending message:", error);
                    showError(
                        "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
                    );
                } finally {
                    isLoading = false;
                    sendButton.disabled = false;
                    sendButton.textContent = "ÈÄÅ‰ø°";
                }
            }

            // ‰ºöË©±Â±•Ê≠¥Ë™≠„ÅøËæº„Åø
            async function loadHistory() {
                if (!sessionId) return;

                try {
                    const response = await fetch(
                        `/api/chat/${sessionId}/history`,
                    );
                    if (!response.ok) return;

                    const data = await response.json();
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach((msg) => {
                            addMessage(msg.role, msg.content);
                        });
                    }
                } catch (error) {
                    console.error("Error loading history:", error);
                }
            }

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°„Ç§„Éô„É≥„Éà
            chatForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                sendMessage(message);
            });

            // Enter „Ç≠„Éº„ÅßÈÄÅ‰ø°ÔºàShift+Enter „ÅßÊîπË°åÔºâ
            messageInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event("submit"));
                }
            });

            // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´Â±•Ê≠¥Âæ©ÂÖÉ
            window.addEventListener("DOMContentLoaded", () => {
                loadHistory();
            });
        </script>
    </body>
</html>
